{% extends 'base.html' %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocas/5.0.1/tocas.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocas/5.0.1/tocas.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/zh-tw.js"></script>

<style>
    /* ========================================= */
    /* 1. 基礎設定 & 變數                       */
    /* ========================================= */
    :root {
        --calendar-bg: #333333; 
        --calendar-border: #555555;
        --main-yellow: #fbbd08;
    }

    .dashboard-panel { background-color: #363636; border: 1px solid #444; border-radius: 5px; margin-bottom: 25px; }
    .control-panel { padding: 30px; }
    .data-panel { background-color: #2b2b2b; border-left: 4px solid var(--main-yellow); min-height: 400px; padding: 0; }

    /* ========================================= */
    /* 2. Flatpickr 日曆配色                    */
    /* ========================================= */
    .flatpickr-calendar.dark { 
        background: var(--calendar-bg) !important;
        border: 1px solid var(--calendar-border) !important; 
        box-shadow: 0 15px 40px rgba(0,0,0,0.6) !important; 
    }
    .flatpickr-innerContainer, .flatpickr-days {
        background: var(--calendar-bg) !important;
        border: none !important;
    }
    .flatpickr-months, .flatpickr-months .flatpickr-month {
        background: var(--calendar-bg) !important;
        color: #fff !important;
        fill: #fff !important;
        border-bottom: none !important;
    }
    .flatpickr-current-month .flatpickr-monthDropdown-months {
        background-color: var(--calendar-bg) !important;
        color: #fff !important;
        font-weight: bold;
        appearance: none;
        -webkit-appearance: none;
        border: none !important;
    }
    .flatpickr-current-month .flatpickr-monthDropdown-months .flatpickr-monthDropdown-month {
        background-color: var(--calendar-bg) !important;
        color: #fff !important;
    }
    .flatpickr-current-month input.cur-year {
        background: var(--calendar-bg) !important;
        color: #fff !important;
        font-weight: bold;
    }
    .flatpickr-weekdays { background: var(--calendar-bg) !important; }
    span.flatpickr-weekday { background: var(--calendar-bg) !important; color: #aaa !important; }
    .flatpickr-calendar.arrowTop:before, .flatpickr-calendar.arrowTop:after { border-bottom-color: var(--calendar-bg) !important; }
    .flatpickr-calendar.arrowBottom:before, .flatpickr-calendar.arrowBottom:after { border-top-color: var(--calendar-bg) !important; }
    .flatpickr-day.selected, .flatpickr-day.selected:hover { 
        background: var(--main-yellow) !important; 
        border-color: var(--main-yellow) !important; 
        color: #000 !important; 
        font-weight: bold; 
    }
    .flatpickr-day:hover {
        background: #444 !important; 
        border-color: #444 !important;
    }

    /* ========================================= */
    /* 3. 日曆輸入框樣式                        */
    /* ========================================= */
    .date-picker-wrapper { position: relative; width: 100%; }
    .flatpickr-input {
        background-color: #222 !important;
        border: 1px solid #555 !important;
        color: #fff !important;
        height: 45px !important;
        border-radius: 4px !important;
        padding-left: 15px !important;
        padding-right: 40px !important; 
        font-family: 'Microsoft JhengHei', sans-serif;
        font-size: 1rem !important;
        width: 100% !important;
    }
    .flatpickr-input:hover { border-color: var(--main-yellow) !important; }
    .calendar-icon {
        position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
        pointer-events: none; opacity: 0.6; width: 20px; height: 20px;
    }
    .date-picker-wrapper:hover .calendar-icon { opacity: 1; }

    /* ========================================= */
    /* 4. 其他元件 (Select, Buttons, Table)     */
    /* ========================================= */
    .ts-select, .ts-input input, .ts-button:not(.is-icon) { 
        height: 45px !important; 
        font-size: 1rem !important;
    }
    .ts-select {
        background-color: #222 !important;
        border-color: #555 !important;
        color: #fff !important;
    }
    .ts-select option {
        background-color: #333 !important;
        color: #fff !important;
    }
    label { color: #ccc; font-size: 1rem; margin-bottom: 8px; display: block; font-weight: 500; }
    .ts-table { background: transparent !important; color: #e0e0e0 !important; }
    .ts-table thead th { background-color: #333 !important; color: #fff !important; border-bottom: 1px solid #444 !important; }
    .ts-table tbody td { border-bottom: 1px solid #3f3f3f !important; vertical-align: middle !important; }
    .ts-table tbody tr:hover { background-color: rgba(255, 255, 255, 0.05) !important; }
    .tr-locked { background-color: rgba(0, 0, 0, 0.2) !important; color: #888 !important; }
    dialog button { border-radius: 6px !important; }
    .sort-select {
        background-color: transparent !important;
        color: var(--main-yellow) !important;
        border: 1px solid #555 !important;
        height: 36px !important;
        padding: 0 15px !important;
        font-size: 0.95rem !important;
        border-radius: 4px;
        cursor: pointer;
    }
    .sort-select:hover { background-color: rgba(255,255,255,0.05) !important; border-color: #777 !important; }
    .sort-select option { background-color: #333; color: #fff; }
    .ts-table .ts-button.is-icon {
        width: 34px !important;
        height: 34px !important;
        padding: 0 !important;
        min-width: 0 !important;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
    }
    .ts-table .ts-button.is-icon .ts-icon { margin: 0 !important; }
</style>

<div class="ts-container is-fluid" style="padding: 30px;">
    
    <div class="ts-header is-heavy" style="color: #eee; margin-bottom: 25px; font-size: 1.5rem;">單筆廢棄物呈現</div>
    
    <div class="dashboard-panel control-panel">
        <form method="get" id="searchForm">
            <input type="hidden" name="sort_by" id="hiddenSortInput" value="{{ current_sort }}">
            <input type="hidden" name="page_size" value="{{ current_page_size }}">

            <div class="ts-grid is-relaxed" style="margin-bottom: 25px;">
                <div class="column is-6-wide">
                    <label>開始日期</label>
                    <div class="date-picker-wrapper">
                        <input type="text" id="start_date" name="start_date" value="{{ start_date|default:'' }}" placeholder="YYYY-MM-DD">
                        <svg class="calendar-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </div>
                </div>
                <div class="column is-6-wide">
                    <label>結束日期</label>
                    <div class="date-picker-wrapper">
                        <input type="text" id="end_date" name="end_date" value="{{ end_date|default:'' }}" placeholder="YYYY-MM-DD">
                        <svg class="calendar-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </div>
                </div>
            </div>

            <div class="ts-grid is-relaxed is-4-columns">
                <div class="column">
                    <label>定點</label>
                    <select name="location" class="ts-select is-fluid"><option value="">全部定點</option>{% for loc in locations %}<option value="{{ loc.id }}" {% if selected_location == loc.id|stringformat:"i" %}selected{% endif %}>{{ loc.name }}</option>{% endfor %}</select>
                </div>
                <div class="column">
                    <label>部門</label>
                    <select name="dept" class="ts-select is-fluid"><option value="">全部部門</option>{% for dept in departments %}<option value="{{ dept.id }}" {% if selected_dept == dept.id|stringformat:"i" %}selected{% endif %}>{{ dept.name }}</option>{% endfor %}</select>
                </div>
                <div class="column">
                    <label>過磅人員</label>
                    <select name="weigher" class="ts-select is-fluid"><option value="">全部人員</option>{% for user in weighers %}<option value="{{ user.id }}" {% if selected_weigher == user.id|stringformat:"i" %}selected{% endif %}>{{ user.name }}</option>{% endfor %}</select>
                </div>
                <div class="column" style="display: flex; align-items: flex-end;">
                    <button type="submit" class="ts-button is-primary is-fluid" style="margin-right: 10px;">
                        <span class="ts-icon is-magnifying-glass-icon"></span> 查詢
                    </button>
                    <button type="button" class="ts-button is-secondary" onclick="clearAllFilters()" style="width: 80px;">
                        <span class="ts-icon is-rotate-left-icon"></span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <div class="dashboard-panel data-panel">
        <div class="ts-content is-secondary is-fitted" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background-color: #333; border-bottom: 1px solid #3f3f3f;">
            <div class="ts-wrap is-middle-aligned">
                <div class="ts-header" style="margin: 0; color: #fff; font-size: 1.1rem; margin-right: 15px;">查詢結果</div>
                <span class="ts-text is-small" style="color: #999;">(共 {{ page_obj.paginator.count|default:"0" }} 筆)</span>
            </div>
            
            <div class="ts-wrap is-middle-aligned">
                <div style="margin-right: 25px; display: flex; align-items: center;">
                    <span style="color: #aaa; font-size: 0.95rem; margin-right: 10px;">排序：</span>
                    <select class="sort-select" onchange="submitWithSort(this.value)">
                        <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>時間 (新 → 舊) ↓</option>
                        <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>時間 (舊 → 新) ↑</option>
                        <option value="weight_desc" {% if current_sort == 'weight_desc' %}selected{% endif %}>重量 (重 → 輕) ↓</option>
                        <option value="weight_asc" {% if current_sort == 'weight_asc' %}selected{% endif %}>重量 (輕 → 重) ↑</option>
                    </select>
                </div>
                <div style="width: 1px; height: 24px; background: #555; margin-right: 25px;"></div>
                <div style="margin-right: 25px; color: #e0e0e0; font-size: 1rem;">
                    選取總重：<span id="displayTotalWeight" style="color: #fbbd08; font-weight: bold; font-size: 1.3rem; margin: 0 5px;">0.00</span> kg
                </div>
                <button type="button" class="ts-button is-positive" onclick="openSettlementModal()">
                    <span class="ts-icon is-calculator-icon"></span> 結算
                </button>
                <button type="button" id="btnBatchDelete" class="ts-button is-negative" onclick="openBatchDelete()" style="margin-left: 10px;">
                    <span class="ts-icon is-trash-can-icon"></span> <span id="btnBatchDeleteText">刪除</span>
                </button>
            </div>
        </div>
        
        <div class="ts-content is-fitted">
            <table class="ts-table is-celled is-striped is-fullwidth">
                <thead>
                    <tr>
                        <th class="collapsing"><label class="ts-checkbox"><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></label></th>
                        <th>過磅時間</th>
                        <th>重量 (kg)</th>
                        <th>狀態</th>
                        <th>部門</th>
                        <th>定點</th>
                        <th>過磅人員</th>
                        <th>更新人員</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in page_obj %}
                    <tr id="row_{{ record.id }}" class="{% if not record.can_delete %}tr-locked{% endif %}">
                        <td class="collapsing">
                            <label class="ts-checkbox">
                                <input type="checkbox" name="record_ids" value="{{ record.id }}" class="record-checkbox" data-weight="{{ record.weight }}" onchange="updateUI()" {% if not record.can_delete %}disabled{% endif %}>
                            </label>
                        </td>
                        <td>
                            {{ record.create_time|date:"Y-m-d H:i" }}
                            {% if record.is_expired and not record.is_transported %}
                                <span class="ts-text is-micro is-negative" style="display:block; margin-top:2px; font-weight:bold;">⚠️ 異常：過期未處理</span>
                            {% elif record.is_expired %}
                                <span class="ts-text is-micro" style="display:block; margin-top:2px; color: #888;">(已歸檔)</span>
                            {% endif %}
                        </td>
                        <td>{{ record.weight }}</td>
                        <td>
                            {% if record.is_transported %}<span class="ts-label is-success">已載運</span>{% else %}<span class="ts-label is-secondary">未載運</span>{% endif %}
                        </td>
                        <td>{{ record.department.name }}</td>
                        <td>{{ record.location.name }}</td>
                        <td>{{ record.creator.name }}</td>
                        <td>{{ record.updater.name|default:"-" }}</td>
                        <td>
                            {% if record.can_delete %}
                                <button class="ts-button is-negative is-icon is-small is-dense" type="button" onclick="deleteRecord({{ record.id }})"><span class="ts-icon is-trash-can-icon"></span></button>
                            {% else %}
                                <button class="ts-button is-disabled is-icon is-small is-dense" type="button"><span class="ts-icon is-lock-icon"></span></button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" style="text-align: center !important; padding: 60px 0; color: #777;">
                            <div class="ts-icon is-file-circle-question-icon" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #888;">資料表內沒有資料</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="ts-content is-secondary" style="background-color: #333; border-top: 1px solid #3f3f3f; padding: 15px 25px;">
            <div class="ts-grid is-middle-aligned is-between">
                <div class="column">
                    <div class="ts-wrap is-middle-aligned">
                        <span style="color: #ccc; margin-right: 10px; font-size: 0.95rem;">每頁顯示：</span>
                        <select class="ts-select is-small" style="background-color: #222; color: #fff; border-color: #555; width: auto;" onchange="changePageSize(this.value)">
                            <option value="10" {% if current_page_size == 10 %}selected{% endif %}>10</option>
                            <option value="20" {% if current_page_size == 20 %}selected{% endif %}>20</option>
                            <option value="50" {% if current_page_size == 50 %}selected{% endif %}>50</option>
                        </select>
                    </div>
                </div>
                <div class="column">
                    <div class="ts-pagination is-small is-secondary">
                        {% with params="start_date="|add:start_date|add:"&end_date="|add:end_date|add:"&location="|add:selected_location|add:"&dept="|add:selected_dept|add:"&weigher="|add:selected_weigher|add:"&sort_by="|add:current_sort|add:"&page_size="|add:current_page_size %}
                            {% if page_obj.has_previous %}<a class="item" href="?{{ params }}&page={{ page_obj.previous_page_number }}"><span class="ts-icon is-chevron-left-icon"></span></a>{% else %}<span class="item is-disabled"><span class="ts-icon is-chevron-left-icon"></span></span>{% endif %}
                            <span class="item is-text">第 {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} 頁</span>
                            {% if page_obj.has_next %}<a class="item" href="?{{ params }}&page={{ page_obj.next_page_number }}"><span class="ts-icon is-chevron-right-icon"></span></a>{% else %}<span class="item is-disabled"><span class="ts-icon is-chevron-right-icon"></span></span>{% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<dialog id="settlementModal" style="padding:0;border:none;background:transparent;margin:auto;"><div style="width:500px;max-width:95vw;background:#2b2b2b;color:#e0e0e0;border-radius:5px;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.5);"><div style="padding:15px 20px;border-bottom:1px solid #3f3f3f;font-weight:bold;color:#fff;">確認結算</div><div style="padding:20px;"><div style="background:#333;padding:15px;border-radius:5px;margin-bottom:20px;border:1px solid #3f3f3f;"><div style="margin-bottom:8px;color:#ccc;">目前時間：<span id="modalCurrentTime" style="color:#fff;"></span></div><div style="color:#ccc;">您已選取：<strong id="modalSelectedCount" style="color:#4db8ff;">0</strong> 筆資料</div></div><form id="settlementForm" method="post" class="ts-form">{% csrf_token %}<input type="hidden" name="selected_ids" id="hiddenSelectedIds"><div class="field"><label style="color:#ccc;">處理公司</label><select name="process_agency" class="ts-basic is-fluid" style="background:#3f3f3f;color:#fff;border-color:#555;">{% for agency in process_agencies %}<option value="{{ agency.id }}">{{ agency.name }}</option>{% endfor %}</select></div><div class="field"><label style="color:#ccc;">清理公司</label><select name="clear_agency" class="ts-basic is-fluid" style="background:#3f3f3f;color:#fff;border-color:#555;">{% for agency in clear_agencies %}<option value="{{ agency.id }}">{{ agency.name }}</option>{% endfor %}</select></div></form></div><div style="padding:15px 20px;border-top:1px solid #3f3f3f;text-align:right;background:#2b2b2b;"><button onclick="document.getElementById('settlementModal').close()" style="background:transparent;border:1px solid #555;color:#ddd;padding:8px 20px;margin-right:10px; cursor: pointer;">取消</button><button onclick="document.getElementById('settlementForm').submit()" style="background:#2185d0;border:none;color:#fff;padding:8px 25px; cursor: pointer;">確認</button></div></div></dialog>
<dialog id="deleteModal" style="padding:0;border:none;background:transparent;margin:auto;"><div style="width:450px;max-width:90vw;background:#222;color:#fff;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.5);text-align:center;"><div style="padding:40px 30px 20px;"><div style="display:inline-flex;align-items:center;justify-content:center;width:70px;height:70px;background:#fff;color:#000;border-radius:50%;font-size:35px;margin-bottom:20px;"><span class="ts-icon is-question-icon"></span></div><div style="font-size:1.5rem;font-weight:bold;margin-bottom:15px;">確認刪除</div><p style="color:#aaa;background:rgba(255,255,255,0.05);padding:10px;border-radius:5px;">確定要刪除這些資料嗎？<br>此動作無法復原。</p></div><div style="padding:20px 30px 30px;display:flex;gap:15px;"><button onclick="closeDeleteModal()" style="flex:1;padding:12px;background:#e0e0e0;color:#333;border:none; font-weight:bold; cursor: pointer;">取消</button><button onclick="confirmDelete()" style="flex:1;padding:12px;background:#db2828;color:#fff;border:none; font-weight:bold; cursor: pointer;">確定</button></div></div></dialog>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const config = { locale: "zh_tw", dateFormat: "Y-m-d", allowInput: true, theme: "dark", disableMobile: "true" };
        flatpickr("#start_date", config);
        flatpickr("#end_date", config);
    });

    window.submitWithSort = function(sortValue) {
        document.getElementById('hiddenSortInput').value = sortValue;
        document.getElementById('searchForm').submit();
    }

    window.pendingDeleteIds = null;
    window.toggleAll = function(src){document.querySelectorAll('.record-checkbox:not([disabled])').forEach(cb=>{cb.checked=src.checked;});updateUI();}
    window.updateUI = function(){let total=0;const checkedBoxes=document.querySelectorAll('.record-checkbox:checked');checkedBoxes.forEach(cb=>{let w=parseFloat(cb.getAttribute('data-weight'));if(!isNaN(w))total+=w;});const display=document.getElementById('displayTotalWeight');if(display)display.innerText=total.toFixed(2);const count=checkedBoxes.length;const btnText=document.getElementById('btnBatchDeleteText');if(btnText){btnText.innerText=count>0?`刪除 (${count})`:"刪除";}}
    window.getSelectedIds = function(){const checkboxes=document.querySelectorAll('.record-checkbox:checked');return Array.from(checkboxes).map(cb=>cb.value);}
    window.openSettlementModal = function(){let ids=getSelectedIds();if(ids.length===0)return alert('請至少選取一筆資料');document.getElementById('modalSelectedCount').innerText=ids.length;document.getElementById('hiddenSelectedIds').value=ids.join(',');document.getElementById('modalCurrentTime').innerText=new Date().toLocaleString();document.getElementById('settlementModal').showModal();}
    window.openBatchDelete = function(){let ids=getSelectedIds();if(ids.length===0)return alert('請至少選取一筆資料');window.pendingDeleteIds=ids;document.getElementById('deleteModal').showModal();}
    window.deleteRecord = function(id){window.pendingDeleteIds=[id];document.getElementById('deleteModal').showModal();}
    window.closeDeleteModal = function(){window.pendingDeleteIds=null;document.getElementById('deleteModal').close();}
    window.confirmDelete = function(){if(window.pendingDeleteIds&&window.pendingDeleteIds.length>0){window.pendingDeleteIds.forEach(id=>{let row=document.getElementById('row_'+id);if(row){row.style.transition="opacity 0.3s";row.style.opacity="0";setTimeout(()=>row.remove(),300);}});setTimeout(()=>{window.updateUI();},300);}window.closeDeleteModal();}
    window.clearAllFilters = function(){window.location.href=window.location.pathname;}
    window.changePageSize = function(size){const urlParams=new URLSearchParams(window.location.search);urlParams.set('page_size',size);urlParams.set('page',1);window.location.search=urlParams.toString();}
</script>

{% endblock %}