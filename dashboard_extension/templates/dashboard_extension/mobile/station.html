{% extends 'base.html' %}
{% load static %}

{% block content %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    /* === å…¨è¢å¹•ä½ˆå±€ (æ©«å¼) === */
    .station-container {
        display: flex;
        flex-direction: row;
        height: calc(100vh - 80px); /* æ‰£æ‰é ‚éƒ¨å°èˆªåˆ— */
        gap: 20px;
        padding: 20px;
        background-color: var(--my-bg-base);
        box-sizing: border-box;
        overflow: hidden; /* ç¦æ­¢å¤–å±¤æ²å‹• */
    }

    /* === å·¦å´ï¼šç›¸æ©Ÿå€ === */
    .left-panel {
        flex: 1; /* ä½” 50% */
        display: flex;
        flex-direction: column;
        background: #000;
        border-radius: 16px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        justify-content: center;
        align-items: center;
    }

    /* é¡é ­ç•«é¢å…ƒç´  */
    #reader {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none; /* é è¨­éš±è— */
    }

    /* å¾…æ©Ÿç•«é¢ (çœé›»æ¨¡å¼) */
    .camera-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #666;
        text-align: center;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0; left: 0;
        background: #1a1a1a;
        z-index: 5;
    }

    /* åœ“å½¢é–‹å•ŸæŒ‰éˆ• */
    .btn-camera-start {
        width: 180px; height: 180px; border-radius: 50%;
        border: 4px solid #2185d0;
        background: rgba(33, 133, 208, 0.1);
        color: #2185d0;
        font-size: 1.2rem; font-weight: bold;
        cursor: pointer;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        transition: all 0.3s;
        box-shadow: 0 0 20px rgba(33, 133, 208, 0.2);
    }
    .btn-camera-start:hover { background: #2185d0; color: white; transform: scale(1.05); }
    .btn-camera-start i { font-size: 3rem; margin-bottom: 10px; }

    /* é—œé–‰é¡é ­æŒ‰éˆ• (æµ®å‹•æ–¼å³ä¸Šè§’) */
    .btn-camera-stop {
        position: absolute; top: 20px; right: 20px; z-index: 20;
        background: rgba(0, 0, 0, 0.6); color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 8px 15px; border-radius: 20px;
        cursor: pointer; display: none;
    }
    .btn-camera-stop:hover { background: #db2828; border-color: #db2828; }

    /* === å³å´ï¼šæ“ä½œå€ === */
    .right-panel {
        flex: 1; /* ä½” 50% */
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding-left: 10px;
        overflow-y: auto; /* å…§å®¹å¤šæ™‚å¯æ²å‹• */
    }

    /* è³‡è¨Šå¡ç‰‡ */
    .info-card {
        background-color: var(--my-bg-panel);
        border: 1px solid var(--my-border);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .card-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 15px; border-bottom: 1px solid var(--my-border); padding-bottom: 10px;
    }
    .header-title { font-size: 0.9rem; font-weight: bold; color: var(--my-text-sub); letter-spacing: 1px; }

    .field-row { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
    .field-label { color: var(--my-text-sub); font-size: 0.9rem; }
    .field-value { color: var(--my-text-main); font-size: 1.1rem; font-weight: 500; }

    /* é‡é‡é¡¯ç¤ºå€ */
    .weight-display-container {
        background: var(--my-bg-input);
        border: 2px solid var(--my-border);
        border-radius: 12px;
        padding: 10px;
        text-align: center;
        position: relative;
        margin-top: 10px;
    }
    
    .big-input {
        width: 100%; height: 80px; font-size: 3.5rem; text-align: center;
        background: transparent; color: #fbbd08;
        border: none; font-weight: bold; outline: none; cursor: default;
    }
    /* ç§»é™¤æ•¸å­—è¼¸å…¥æ¡†çš„ä¸Šä¸‹ç®­é ­ */
    .big-input::-webkit-outer-spin-button, .big-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .big-input[type=number] { -moz-appearance: textfield; }
    
    .unit-tag {
        position: absolute; right: 20px; bottom: 25px;
        font-size: 1.2rem; font-weight: bold; color: var(--my-text-sub);
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-large {
        width: 100%; height: 60px; font-size: 1.1rem; font-weight: bold;
        border-radius: 12px; border: none; cursor: pointer; color: white;
        display: flex; align-items: center; justify-content: center;
        transition: transform 0.1s, background 0.2s; gap: 10px;
    }
    .btn-large:active { transform: scale(0.98); }
    .btn-submit { background: linear-gradient(135deg, #21ba45, #19a53a); }
    .btn-submit:disabled { background: #444; color: #888; cursor: not-allowed; }
    
    /* è—ç‰™æŒ‰éˆ• */
    .btn-bluetooth {
        background: #2b2b2b; border: 1px solid var(--my-border); color: var(--my-text-main);
        font-size: 0.9rem; height: 36px; padding: 0 15px; border-radius: 18px;
        cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;
    }
    .btn-bluetooth:hover { background: #333; }
    .btn-bluetooth.connected { background: rgba(33, 186, 69, 0.1); color: #21ba45; border-color: #21ba45; }

    /* === ğŸŸ¢ è—ç‰™æƒæè¦–çª— (Modal) === */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: none; /* é è¨­éš±è— */
        justify-content: center; align-items: center;
    }
    
    .modal-content {
        background: var(--my-bg-panel);
        width: 90%; max-width: 400px;
        border-radius: 16px;
        border: 1px solid var(--my-border);
        padding: 20px;
        display: flex; flex-direction: column;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: var(--my-text-main); text-align: center; }
    
    .device-list {
        list-style: none; padding: 0; margin: 0;
        max-height: 200px; overflow-y: auto;
        border: 1px solid var(--my-border); border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .device-item {
        padding: 12px 15px;
        border-bottom: 1px solid var(--my-border);
        cursor: pointer;
        display: flex; align-items: center; justify-content: space-between;
        color: var(--my-text-sub);
    }
    .device-item:last-child { border-bottom: none; }
    .device-item:hover { background: rgba(255,255,255,0.05); }
    
    .device-item.selected {
        background: rgba(33, 133, 208, 0.1);
        color: #2185d0;
        font-weight: bold;
    }
    .device-item.selected::after {
        content: 'âœ“'; color: #2185d0;
    }

    .scanning-animation {
        text-align: center; padding: 20px; color: var(--my-text-sub);
    }

    .modal-actions { display: flex; gap: 10px; }
    .btn-modal { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
    .btn-cancel { background: #555; color: white; }
    .btn-confirm { background: #2185d0; color: white; }
    .btn-confirm:disabled { background: #333; color: #666; cursor: not-allowed; }

    /* RWD: æ‰‹æ©Ÿç›´ç«‹æ™‚è‡ªå‹•è®Šå›ç›´å¼ */
    @media (max-width: 768px) {
        .station-container { flex-direction: column; height: auto; overflow-y: auto; }
        .left-panel { height: 300px; flex: none; }
        .right-panel { flex: none; }
    }
</style>

<div class="station-container">
    <div class="left-panel">
        <button class="btn-camera-stop" id="btn-stop-cam" onclick="stopScanner()">
            <span class="ts-icon is-circle-xmark-icon" style="margin-right: 5px;"></span>é—œé–‰é¡é ­
        </button>
        <div id="reader"></div>
        <div class="camera-placeholder" id="cam-placeholder">
            <button class="btn-camera-start" onclick="startScanner()">
                <span class="ts-icon is-camera-icon" style="font-size: 2.5rem; margin-bottom: 5px;"></span>
                é–‹å•Ÿé¡é ­
            </button>
            <div style="margin-top: 15px;">é»æ“Šé–‹å•Ÿä»¥æƒæ QR Code</div>
        </div>
    </div>

    <div class="right-panel">
        <div class="info-card">
            <div class="card-header">
                <span class="header-title">SCRAP INFO</span>
                <span id="scan-status-badge" class="ts-badge is-small is-disabled">ç­‰å¾…æƒæ</span>
            </div>
            <div class="field-row"><span class="field-label">éƒ¨é–€ Dept.</span><span class="field-value" id="disp_dept">---</span></div>
            <div class="field-row"><span class="field-label">å®šé» Loc.</span><span class="field-value" id="disp_loc">---</span></div>
            <div class="field-row"><span class="field-label">äººå“¡ User</span><span class="field-value" id="disp_user">---</span></div>
            <input type="hidden" id="hidden_loc_id">
        </div>

        <div class="info-card">
            <div class="card-header" style="border:none; padding-bottom:0;">
                <span class="header-title">WEIGHT SCALE</span>
                <button class="btn-bluetooth" id="btn-bt-connect" onclick="openBluetoothModal()">
                    <span class="ts-icon is-bluetooth-icon"></span>
                    <span id="bt-text">æœå°‹ç£…ç§¤</span>
                </button>
            </div>
            <div class="weight-display-container">
                <input type="number" class="big-input" id="weight_input" placeholder="0.00" readonly>
                <span class="unit-tag">KG</span>
            </div>
            <div style="text-align: center; color: var(--my-text-sub); font-size: 0.85rem; margin-top: 5px;">
                <span id="bt-msg">è«‹å…ˆé€£æ¥è—ç‰™ç£…ç§¤</span>
            </div>
        </div>

        <div style="margin-top: auto;">
            <button class="btn-large btn-submit" id="btn_submit" onclick="submitData()" disabled>
                <span class="ts-icon is-cloud-arrow-up-icon"></span>
                ç¢ºèªä¸Šå‚³ (Upload)
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="bt-modal">
    <div class="modal-content">
        <div class="modal-title">è—ç‰™è£ç½®æƒæ</div>
        
        <div id="bt-searching" class="scanning-animation">
            <span class="ts-loading is-large"></span>
            <div style="margin-top:10px">æ­£åœ¨æœå°‹é™„è¿‘çš„è£ç½®...</div>
        </div>

        <ul class="device-list" id="bt-list" style="display:none;">
            </ul>

        <div class="modal-actions">
            <button class="btn-modal btn-cancel" onclick="closeBluetoothModal()">å–æ¶ˆ</button>
            <button class="btn-modal btn-confirm" id="btn-bt-confirm" onclick="confirmBluetoothDevice()" disabled>é€£ç·š</button>
        </div>
    </div>
</div>

<script>
    let html5QrcodeScanner = null;
    let isScanning = false;
    let selectedDeviceName = null;

    // å‡è³‡æ–™
    const mockLocations = [
        { id: 0, dept: "ç—…ç†æª¢é©—éƒ¨", loc: "B1 æ±™ç‰©å®¤", user: "ç‹å°æ˜" },
        { id: 1, dept: "æ€¥è¨ºå®¤", loc: "ä¸€æ¨“å¤§å»³", user: "æå¤§è¯" },
        { id: 2, dept: "æ”¾å°„ç§‘", loc: "äºŒæ¨“è­·ç†ç«™", user: "å¼µé˜¿å§¨" }
    ];

    // ==========================================
    // 1. é¡é ­æ§åˆ¶ (ç¯€èƒ½æ¨¡å¼)
    // ==========================================
    function startScanner() {
        document.getElementById('cam-placeholder').style.display = 'none';
        document.getElementById('reader').style.display = 'block';
        document.getElementById('btn-stop-cam').style.display = 'block';

        html5QrcodeScanner = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        // å˜—è©¦ä½¿ç”¨å¾Œé¡é ­
        html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => {
            alert('ç„¡æ³•å•Ÿå‹•é¡é ­ (è«‹å…è¨±ç€è¦½å™¨å­˜å–ç›¸æ©Ÿ)');
            stopScanner();
        });
        isScanning = true;
    }

    function stopScanner() {
        if (html5QrcodeScanner && isScanning) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                isScanning = false;
                document.getElementById('reader').style.display = 'none';
                document.getElementById('btn-stop-cam').style.display = 'none';
                document.getElementById('cam-placeholder').style.display = 'flex';
            }).catch(err => console.log("Stop failed", err));
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        // æƒåˆ°å¾Œè‡ªå‹•é—œé–‰é¡é ­ (çœé›»)
        stopScanner();
        
        // éš¨æ©Ÿå¸¶å…¥ä¸€ç­†è³‡æ–™
        const randomData = mockLocations[Math.floor(Math.random() * mockLocations.length)];
        
        document.getElementById('disp_dept').innerText = randomData.dept;
        document.getElementById('disp_loc').innerText = randomData.loc;
        document.getElementById('disp_user').innerText = randomData.user;
        document.getElementById('hidden_loc_id').value = randomData.id;

        const badge = document.getElementById('scan-status-badge');
        badge.className = 'ts-badge is-positive';
        badge.innerHTML = '<span class="ts-icon is-check-icon"></span> æƒææˆåŠŸ';

        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¸Šå‚³
        checkSubmitReady();
    }

    // ==========================================
    // 2. è—ç‰™é€£æ¥ (å«çœŸå¯¦æª¢æŸ¥ + æ¨¡æ“¬æœå°‹)
    // ==========================================
    async function openBluetoothModal() {
        // æ­¥é©Ÿ A: å˜—è©¦æª¢æŸ¥çœŸå¯¦è—ç‰™ç‹€æ…‹
        if (navigator.bluetooth) {
            try {
                const isAvailable = await navigator.bluetooth.getAvailability();
                if (!isAvailable) {
                    alert("âš ï¸ åµæ¸¬åˆ°æ‚¨çš„è—ç‰™æœªé–‹å•Ÿï¼\nè«‹å…ˆé–‹å•Ÿè—ç‰™åŠŸèƒ½ä»¥é€£æ¥ç£…ç§¤ã€‚");
                    return; // é˜»æ­¢å¾ŒçºŒæµç¨‹
                }
            } catch (error) {
                console.log("è—ç‰™æª¢æŸ¥å¤±æ•—ï¼Œç•¥éæª¢æŸ¥:", error);
            }
        }

        // æ­¥é©Ÿ B: é–‹å•Ÿæ¨¡æ“¬æœå°‹è¦–çª—
        document.getElementById('bt-modal').style.display = 'flex';
        document.getElementById('bt-searching').style.display = 'block';
        document.getElementById('bt-list').style.display = 'none';
        document.getElementById('bt-list').innerHTML = '';
        document.getElementById('btn-bt-confirm').disabled = true;
        selectedDeviceName = null;

        // æ¨¡æ“¬æœå°‹æ™‚é–“ (1.5ç§’)
        setTimeout(() => {
            document.getElementById('bt-searching').style.display = 'none';
            document.getElementById('bt-list').style.display = 'block';
            
            const devices = [
                "Medical Waste Scale #01",
                "Mi Smart Scale 2",
                "Unknown Device (CC:21:44)"
            ];
            
            const listEl = document.getElementById('bt-list');
            devices.forEach(dev => {
                const li = document.createElement('li');
                li.className = 'device-item';
                li.innerText = dev;
                li.onclick = () => selectDevice(li, dev);
                listEl.appendChild(li);
            });
        }, 1500);
    }

    function closeBluetoothModal() {
        document.getElementById('bt-modal').style.display = 'none';
    }

    function selectDevice(element, devName) {
        document.querySelectorAll('.device-item').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        selectedDeviceName = devName;
        document.getElementById('btn-bt-confirm').disabled = false;
    }

    function confirmBluetoothDevice() {
        closeBluetoothModal();

        const btn = document.getElementById('btn-bt-connect');
        const msg = document.getElementById('bt-msg');
        const weightInput = document.getElementById('weight_input');

        btn.className = "btn-bluetooth connected";
        btn.innerHTML = `<span class="ts-icon is-link-icon"></span> ${selectedDeviceName}`;
        
        msg.innerText = "æ­£åœ¨è®€å–æ•¸æ“š...";
        msg.style.color = "#21ba45";

        // æ¨¡æ“¬è®€å–å»¶é²
        setTimeout(() => {
            const randomWeight = (Math.random() * 10 + 5).toFixed(2);
            weightInput.value = randomWeight;
            msg.innerText = "ç©©å®šè®€æ•¸ (Stable)";
            checkSubmitReady();
        }, 800);
    }

    // æª¢æŸ¥æ˜¯å¦æ»¿è¶³ä¸Šå‚³æ¢ä»¶
    function checkSubmitReady() {
        const locId = document.getElementById('hidden_loc_id').value;
        const weight = document.getElementById('weight_input').value;
        
        if (locId && weight && parseFloat(weight) > 0) {
            document.getElementById('btn_submit').disabled = false;
        }
    }

    // ==========================================
    // 3. ä¸Šå‚³è³‡æ–™
    // ==========================================
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function submitData() {
        const locId = document.getElementById('hidden_loc_id').value;
        const weight = document.getElementById('weight_input').value;
        
        const btn = document.getElementById('btn_submit');
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="ts-loading"></span> ä¸Šå‚³ä¸­...';

        fetch("{% url 'dashboard:api_record_waste' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                location_id: locId,
                weight: weight
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`âœ… ä¸Šå‚³æˆåŠŸï¼\nåœ°é»: ${document.getElementById('disp_loc').innerText}\né‡é‡: ${weight} KG`);
                window.location.reload(); 
            } else {
                alert('âŒ å¤±æ•—: ' + data.message);
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        })
        .catch(err => {
            alert('âŒ éŒ¯èª¤: ' + err);
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        });
    }
</script>
{% endblock %}