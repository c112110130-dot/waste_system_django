{% extends 'base.html' %}
{% load static %}

{% block content %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    /* å…¨è¢å¹•ä½ˆå±€è¨­å®š (æ©«å¼) */
    .station-container {
        display: flex;
        flex-direction: row; /* æ©«å‘æ’åˆ— */
        height: calc(100vh - 80px); /* æ‰£æ‰å°èˆªåˆ—é«˜åº¦ */
        gap: 20px;
        padding: 20px;
        background-color: var(--my-bg-base);
        box-sizing: border-box;
        overflow: hidden; /* é˜²æ­¢æ²å‹• */
    }

    /* å·¦å´é¢æ¿ï¼šæƒæå€ */
    .left-panel {
        flex: 1; /* ä½” 50% */
        display: flex;
        flex-direction: column;
        background: #000; /* é¡é ­èƒŒæ™¯é»‘åº• */
        border-radius: 16px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    /* é¡é ­ç•«é¢ */
    #reader {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* æƒæç‹€æ…‹è¦†è“‹å±¤ */
    .scan-overlay {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        z-index: 10;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* å³å´é¢æ¿ï¼šæ“ä½œå€ */
    .right-panel {
        flex: 1; /* ä½” 50% */
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding-left: 10px;
        overflow-y: auto; /* å…§å®¹å¤šæ™‚å¯æ²å‹• */
    }

    /* è³‡è¨Šå¡ç‰‡ */
    .info-card {
        background-color: var(--my-bg-panel);
        border: 1px solid var(--my-border);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* æ¨™é¡Œèˆ‡æ¨™ç±¤ */
    .card-header {
        font-size: 0.85rem;
        font-weight: bold;
        color: var(--my-text-sub);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 12px;
        border-bottom: 1px solid var(--my-border);
        padding-bottom: 8px;
    }

    .field-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        align-items: center;
    }
    
    .field-label { color: var(--my-text-sub); font-size: 0.9rem; }
    .field-value { color: var(--my-text-main); font-size: 1.1rem; font-weight: 500; }

    /* é‡é‡è¼¸å…¥æ¡† (è¶…å¤§) */
    .weight-display {
        background: var(--my-bg-input);
        border: 2px solid var(--my-border);
        border-radius: 12px;
        padding: 10px;
        text-align: center;
        position: relative;
    }
    
    .big-input {
        width: 100%;
        height: 80px;
        font-size: 3.5rem;
        text-align: center;
        background: transparent;
        color: #fbbd08;
        border: none;
        font-weight: bold;
        outline: none;
    }
    
    .unit-tag {
        position: absolute;
        right: 20px;
        bottom: 20px;
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--my-text-sub);
    }

    /* æŒ‰éˆ• */
    .btn-large {
        width: 100%;
        height: 60px;
        font-size: 1.2rem;
        font-weight: bold;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.1s;
    }
    .btn-large:active { transform: scale(0.98); }
    .btn-submit { background: linear-gradient(135deg, #21ba45, #19a53a); }
    .btn-reset { background: #555; height: 40px; font-size: 1rem; margin-top: 10px; }

    .btn-submit:disabled {
        background: #444;
        color: #888;
        cursor: not-allowed;
    }

    /* è—ç‰™ç‹€æ…‹ */
    .bt-status {
        display: flex; align-items: center; gap: 6px;
        font-size: 0.9rem; color: var(--my-text-sub);
    }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
    .dot.active { background: #00d1b2; box-shadow: 0 0 8px #00d1b2; }

    /* RWD: å¦‚æœè¢å¹•çœŸçš„å¾ˆçª„ (ä¾‹å¦‚æ‰‹æ©Ÿç›´æ‹¿)ï¼Œè‡ªå‹•è®Šå›ç›´å¼ */
    @media (max-width: 768px) {
        .station-container { flex-direction: column; height: auto; overflow-y: auto; }
        .left-panel { height: 300px; flex: none; }
        .right-panel { flex: none; }
    }
</style>

<div class="station-container">
    
    <div class="left-panel">
        <div id="reader"></div>
        <div class="scan-overlay" id="scan-status-text">
            <span class="ts-loading is-small"></span>ç­‰å¾…é¡é ­å•Ÿå‹•...
        </div>
    </div>

    <div class="right-panel">
        
        <div class="info-card">
            <div class="card-header">SCRAP INFORMATION</div>
            
            <div class="field-row">
                <span class="field-label">éƒ¨é–€ Dept.</span>
                <span class="field-value" id="disp_dept">---</span>
            </div>
            <div class="field-row">
                <span class="field-label">å®šé» Loc.</span>
                <span class="field-value" id="disp_loc">---</span>
            </div>
            <div class="field-row">
                <span class="field-label">äººå“¡ User</span>
                <span class="field-value" id="disp_user">---</span>
            </div>
            
            <input type="hidden" id="hidden_loc_id">
        </div>

        <div class="info-card">
            <div class="card-header" style="display:flex; justify-content:space-between; border:none; padding-bottom:0;">
                <span>WEIGHT SCALE</span>
                <div class="bt-status">
                    <div class="dot" id="bt-dot"></div> BT Connected
                </div>
            </div>
            
            <div class="weight-display">
                <input type="number" class="big-input" id="weight_input" placeholder="0.00" step="0.01">
                <span class="unit-tag">KG</span>
            </div>
        </div>

        <div style="margin-top: auto;">
            <button class="btn-large btn-submit" id="btn_submit" onclick="submitData()" disabled>
                <span class="ts-icon is-cloud-arrow-up-icon" style="margin-right: 10px;"></span>
                ç¢ºèªä¸Šå‚³
            </button>
            
            <button class="btn-large btn-reset" onclick="resetScanner()">
                <span class="ts-icon is-rotate-right-icon" style="margin-right: 8px;"></span>
                é‡æ–°æƒæ
            </button>
        </div>

    </div>
</div>

<script>
    let html5QrcodeScanner = null;
    let isScanning = true;

    // æ¨¡æ“¬è³‡æ–™åº« (å°æ‡‰å¾Œç«¯ ID)
    const mockLocations = [
        { id: 0, dept: "ç—…ç†æª¢é©—éƒ¨", loc: "B1 æ±™ç‰©å®¤", user: "ç‹å°æ˜" },
        { id: 1, dept: "æ€¥è¨ºå®¤", loc: "ä¸€æ¨“å¤§å»³", user: "æå¤§è¯" },
        { id: 2, dept: "æ”¾å°„ç§‘", loc: "äºŒæ¨“è­·ç†ç«™", user: "å¼µé˜¿å§¨" }
    ];

    // åˆå§‹åŒ–æƒæå™¨
    function startScanner() {
        const statusText = document.getElementById('scan-status-text');
        statusText.innerHTML = '<span class="ts-loading is-small"></span> æ­£åœ¨é–‹å•Ÿé¡é ­...';

        html5QrcodeScanner = new Html5Qrcode("reader");
        
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        // å„ªå…ˆä½¿ç”¨å¾Œé¡é ­ (environment)ï¼Œè‹¥å¤±æ•—å‰‡ç”¨å‰é¡é ­ (user)
        html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
        .then(() => {
            statusText.innerHTML = '<span class="ts-icon is-camera-icon"></span> è«‹å°‡ QR Code å°æº–æ¡†æ¡†';
        })
        .catch(err => {
            console.error(err);
            statusText.innerHTML = '<span class="ts-icon is-circle-exclamation-icon"></span> ç„¡æ³•å•Ÿå‹•é¡é ­ (è«‹å…è¨±æ¬Šé™)';
            
            // å¦‚æœæ˜¯åœ¨é›»è…¦ç„¡é¡é ­ç’°å¢ƒï¼Œæä¾›ä¸€å€‹ "é»æ“Šæ¨¡æ“¬æƒæ" çš„å¾Œé–€
            document.getElementById('reader').onclick = () => onScanSuccess("Simulated_QR_Code");
        });
    }

    // æƒææˆåŠŸå›å‘¼å‡½å¼
    function onScanSuccess(decodedText, decodedResult) {
        if (!isScanning) return;
        
        // åœæ­¢æƒæ
        isScanning = false;
        html5QrcodeScanner.pause(); 
        
        // æ’­æ”¾éŸ³æ•ˆ (å¯é¸)
        // const audio = new Audio('/static/beep.mp3'); audio.play();

        // ğŸŸ¢ æ¼”ç¤ºç”¨é‚è¼¯ï¼šä¸ç®¡æƒåˆ°ä»€éº¼ï¼Œéƒ½éš¨æ©ŸæŒ‘ä¸€ç­†è³‡æ–™å¡«å…¥ (ç¢ºä¿æ¼”ç¤ºä¸€å®šæˆåŠŸ)
        // å¯¦å‹™ä¸Šé€™è£¡æ‡‰è©²æ˜¯è§£æ decodedText (ä¾‹å¦‚ JSON)
        const randomData = mockLocations[Math.floor(Math.random() * mockLocations.length)];
        
        updateUI(randomData, decodedText);
    }

    function onScanFailure(error) {
        // æƒæä¸­...ä¸éœ€è™•ç†éŒ¯èª¤
    }

    // æ›´æ–°ç•«é¢è³‡æ–™
    function updateUI(data, rawText) {
        document.getElementById('disp_dept').innerText = data.dept;
        document.getElementById('disp_loc').innerText = data.loc;
        document.getElementById('disp_user').innerText = data.user;
        document.getElementById('hidden_loc_id').value = data.id;

        // æ›´æ–°ç‹€æ…‹æ–‡å­—
        const statusText = document.getElementById('scan-status-text');
        statusText.style.background = "rgba(33, 186, 69, 0.8)"; // ç¶ è‰²
        statusText.innerHTML = `<span class="ts-icon is-check-icon"></span> æƒææˆåŠŸ: ${data.loc}`;

        // å•Ÿç”¨è¼¸å…¥èˆ‡æŒ‰éˆ•
        document.getElementById('btn_submit').disabled = false;
        document.getElementById('weight_input').focus();
    }

    // é‡ç½®æƒæ
    function resetScanner() {
        isScanning = true;
        document.getElementById('disp_dept').innerText = "---";
        document.getElementById('disp_loc').innerText = "---";
        document.getElementById('disp_user').innerText = "---";
        document.getElementById('hidden_loc_id').value = "";
        document.getElementById('weight_input').value = "";
        document.getElementById('btn_submit').disabled = true;

        const statusText = document.getElementById('scan-status-text');
        statusText.style.background = "rgba(0,0,0,0.6)";
        statusText.innerHTML = '<span class="ts-icon is-camera-icon"></span> è«‹å°‡ QR Code å°æº–æ¡†æ¡†';

        try { html5QrcodeScanner.resume(); } catch(e) { startScanner(); }
    }

    // ä¸Šå‚³è³‡æ–™
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function submitData() {
        const locId = document.getElementById('hidden_loc_id').value;
        const weight = document.getElementById('weight_input').value;
        
        if (!locId) return alert('è«‹å…ˆæƒæï¼');
        if (!weight) return alert('è«‹è¼¸å…¥é‡é‡ï¼');

        const btn = document.getElementById('btn_submit');
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="ts-loading"></span> ä¸Šå‚³ä¸­...';

        fetch("{% url 'dashboard:api_record_waste' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                location_id: locId,
                weight: weight
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`âœ… è³‡æ–™å·²ä¸Šå‚³ï¼\nåœ°é»: ${document.getElementById('disp_loc').innerText}\né‡é‡: ${weight} KG`);
                resetScanner(); // ä¸Šå‚³å®Œè‡ªå‹•é‡ç½®ï¼Œæº–å‚™ä¸‹ä¸€ç­†
            } else {
                alert('âŒ å¤±æ•—: ' + data.message);
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        })
        .catch(err => {
            alert('âŒ éŒ¯èª¤: ' + err);
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        });
    }

    // å•Ÿå‹•æµç¨‹
    window.onload = function() {
        startScanner();
        // æ¨¡æ“¬è—ç‰™é€£ç·š
        setTimeout(() => document.getElementById('bt-dot').classList.add('active'), 1500);
    };
</script>
{% endblock %}