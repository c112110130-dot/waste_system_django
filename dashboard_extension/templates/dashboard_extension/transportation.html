{% extends 'base.html' %}
{% load static %}

{% block title %}å»¢æ£„ç‰©è¼‰é‹ç®¡ç†ç´€éŒ„{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/zh-tw.js"></script>

<style>
    /* ========================================= */
    /* 1. è®Šæ•¸è¨­å®š                                */
    /* ========================================= */
    :root {
        --tp-bg-panel: #363636;
        --tp-bg-input: #222222;
        --tp-text-main: #ffffff;
        --tp-text-sub: #cccccc;
        --tp-border: #555555;
        --tp-hover: rgba(255, 255, 255, 0.05);
        --tp-modal-bg: #2b2b2b;
        --del-icon-bg: #ffffff; --del-icon-fg: #000000;
        --del-cancel-bg: #e0e0e0; --del-cancel-fg: #333333;
    }

    html.is-light {
        --tp-bg-panel: #f7f7f7; --tp-bg-input: #ffffff;
        --tp-text-main: #333333; --tp-text-sub: #555555;
        --tp-border: #dddddd; --tp-hover: rgba(0, 0, 0, 0.05);
        --tp-modal-bg: #ffffff;
        --del-icon-bg: #000000; --del-icon-fg: #ffffff;
        --del-cancel-bg: #333333; --del-cancel-fg: #ffffff;
    }

    /* ========================================= */
    /* 2. åš´æ ¼éš”é›¢æ¨£å¼ (Scoped CSS)              */
    /* ========================================= */

    .transport-page .ts-select, 
    .transport-page .ts-input input, 
    .transport-page .flatpickr-input { 
        height: 38px !important; background-color: var(--tp-bg-input) !important;
        border: 1px solid var(--tp-border) !important; color: var(--tp-text-main) !important;
        border-radius: 4px !important; box-sizing: border-box !important;
        font-size: 1rem !important; width: 100% !important; display: block;
    }

    html.is-dark .flatpickr-calendar { filter: invert(1) hue-rotate(180deg); }

    .transport-page .sort-select { width: auto !important; min-width: 140px; max-width: 200px; }

    .btn-print-custom {
        height: 38px !important; background-color: var(--tp-bg-input) !important;
        border: 1px solid var(--tp-border) !important; color: var(--tp-text-main) !important;
        border-radius: 4px !important; padding: 0 15px !important;
        display: inline-flex !important; align-items: center !important; justify-content: center !important;
        cursor: pointer; font-size: 0.95rem !important; font-weight: bold;
        white-space: nowrap !important; flex-shrink: 0 !important; transition: background-color 0.2s;
    }
    .btn-print-custom:hover { background-color: var(--tp-hover) !important; }

    .btn-delete-main {
        height: 38px !important; background-color: #db2828 !important; border: none !important;
        color: #ffffff !important; border-radius: 4px !important; padding: 0 15px !important;
        display: inline-flex !important; align-items: center !important; justify-content: center !important;
        cursor: pointer; font-size: 0.95rem !important; font-weight: bold;
        white-space: nowrap !important; flex-shrink: 0 !important; transition: background-color 0.2s;
    }
    .btn-delete-main:hover { background-color: #a81010 !important; }
    
    .btn-row-delete {
        background-color: #db2828 !important; color: white !important; border: none !important;
        width: 30px !important; height: 30px !important; border-radius: 4px !important;
        display: inline-flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .btn-row-delete:hover { background-color: #a81010 !important; }

    .transport-page .dashboard-panel .ts-button { height: 38px !important; border-radius: 4px !important; }
    .transport-page .date-picker-wrapper { position: relative; width: 100% !important; display: block; }
    .transport-page .calendar-icon {
        position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
        pointer-events: none; opacity: 0.6; width: 16px; height: 16px; stroke: var(--tp-text-main); z-index: 2;
    }

    .transport-page .dashboard-panel {
        background-color: var(--tp-bg-panel); border: 1px solid var(--tp-border);
        border-radius: 6px; margin-bottom: 20px;
    }
    .transport-page .control-panel { padding: 20px; }
    .transport-page .data-panel { padding: 0; border-left: 4px solid #2185d0; min-height: 400px; }
    .transport-page label { color: var(--tp-text-sub); margin-bottom: 6px; display: block; font-weight: bold; font-size: 0.95rem; }

    .transport-page .ts-table { background: transparent !important; color: var(--tp-text-main) !important; }
    .transport-page .ts-table thead th { background-color: var(--tp-bg-panel) !important; border-bottom: 1px solid var(--tp-border) !important; color: var(--tp-text-main) !important; font-size: 0.95rem; }
    .transport-page .ts-table tbody td { border-bottom: 1px solid var(--tp-border) !important; vertical-align: middle !important; font-size: 0.95rem; }
    .transport-page .ts-table tbody tr:hover { background-color: var(--tp-hover) !important; }

    .custom-modal-content { background: var(--tp-modal-bg) !important; color: var(--tp-text-main) !important; border: 1px solid var(--tp-border); }
    #deleteModal > div { width: 400px; max-width: 90vw; border-radius: 8px; box-shadow: 0 4px 25px rgba(0,0,0,0.2); text-align: center; }
    .delete-icon-circle { display: inline-flex; align-items: center; justify-content: center; width: 60px; height: 60px; border-radius: 50%; margin-bottom: 15px; background: var(--tp-text-main); color: var(--tp-bg-panel); }
    #detailModal > div { width: 800px; max-width: 95vw; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 85vh; }
    .sub-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .sub-table th, .sub-table td { padding: 8px; border-bottom: 1px solid var(--tp-border); color: var(--tp-text-main); }
    
    .total-weight-box { padding: 15px 25px; border-bottom: 1px solid var(--tp-border); background: var(--tp-bg-panel); color: var(--tp-text-sub); text-align: right; font-size: 1rem; }
    .total-weight-value { color: #db2828; font-weight: bold; font-size: 1.3rem; margin-left: 8px; }

    /* ========================================= */
    /* ğŸŸ¢ 3. å ±è¡¨åˆ—å°å°ˆå±¬æ·¨åŒ–æ¨£å¼               */
    /* ========================================= */
    @media print {
        /* 1. çµ‚æ¥µéš±è—ï¼šå¼·åˆ¶æ‹¿æ‰ Hello rootã€Navbarã€å´é‚Šæ¬„ç­‰ä»»ä½•å¤–æ¡† */
        nav, header, footer, aside, 
        .ts-app-navbar, .ts-app-sidebar, .ts-app-topbar, 
        .ts-topbar, .topbar, .navbar, .sidebar, 
        [class*="topbar"], [class*="navbar"], [class*="header"], 
        .user-greeting, #greeting { 
            display: none !important; 
        }

        /* ğŸŸ¢ è§£æ±ºç€è¦½å™¨é è¨­å°å‡ºã€Œç¶²é æ¨™é¡Œã€èˆ‡ã€Œç¶²å€ã€çš„é—œéµ */
        @page { 
            margin: 0; /* è¨­ç‚º 0ï¼Œå–æ¶ˆç€è¦½å™¨è‡ªå¸¶çš„é é¦–/é å°¾ */
        }

        /* æ¶ˆé™¤åŸæœ¬å¤–æ¡†é ç•™çš„é‚Šè·ï¼Œæ”¹ç”¨ body è‡ªå·±çš„ padding ä¾†é˜²æ­¢æ–‡å­—è²¼é½Šç´™å¼µé‚Šç·£ */
        body, html, .ts-app-layout, .ts-app-content, main, .ts-content, .ts-container {
            background: white !important; 
            color: black !important;
            overflow: visible !important;
            margin: 0 !important;
        }
        
        body {
            padding: 1.5cm !important; /* å–ä»£ @page marginï¼Œç•¶ä½œå ±è¡¨ç•™ç™½ */
        }

        .ts-container { padding: 0 !important; max-width: 100% !important; margin: 0 !important;}

        /* 2. éš±è—æœ¬é é¢çš„æ§åˆ¶å…ƒç´ ï¼šç¯©é¸é¢æ¿ã€æ¨™é¡Œæ“ä½œåˆ—ã€åˆ†é åˆ— */
        .control-panel, 
        .data-panel > .ts-content.is-secondary, 
        .ts-pagination { 
            display: none !important; 
        }

        .dashboard-panel { border: none !important; box-shadow: none !important; margin: 0 !important; padding: 0 !important;}
        .data-panel { border-left: none !important; }

        /* 3. éš±è—è¡¨æ ¼ä¸­ä¸éœ€è¦çš„æ¬„ä½ (æœ€å·¦é‚Šæ ¸å–æ–¹å¡Šã€æœ€å³é‚Šæ“ä½œæŒ‰éˆ•) */
        .ts-table th.collapsing, .ts-table td.collapsing,
        .ts-table th:last-child, .ts-table td:last-child { 
            display: none !important; 
        }

        /* 4. éš±è—æ²’æœ‰è¢«å‹¾é¸çš„åˆ— */
        .no-print-row { display: none !important; }

        /* 5. å ±è¡¨å°ˆå±¬ç¾åŒ– */
        .print-header-title { 
            display: block !important; 
            text-align: center; 
            font-size: 1.8rem; 
            font-weight: bold; 
            margin-bottom: 20px; 
            color: black !important;
            border-bottom: 2px solid black;
            padding-bottom: 10px;
        }
        .ts-table { width: 100% !important; border-collapse: collapse !important; }
        .ts-table th { 
            background-color: #f0f0f0 !important; 
            color: black !important; 
            border-bottom: 2px solid #000 !important;
        }
        .ts-table td { 
            color: black !important; 
            border-bottom: 1px solid #ccc !important;
        }
        
        /* ç¸½é‡é‡å€å¡Šç¾åŒ– */
        .total-weight-box { 
            background: transparent !important; 
            color: black !important; 
            border-top: 2px solid #000 !important; 
            border-bottom: none !important; 
            padding: 15px 0 !important;
        }
        .total-weight-value { color: black !important; }
    }
    
    /* ç¶²é æ¨¡å¼ä¸‹éš±è—å°ˆå±¬å ±è¡¨æ¨™é¡Œ */
    .print-header-title { display: none; } 
</style>

<div class="ts-container is-fluid transport-page" style="padding: 20px;">
    
    <div class="print-header-title">å»¢æ£„ç‰©è¼‰é‹ç´€éŒ„å ±è¡¨</div>

    <div class="dashboard-panel control-panel">
        <form method="get" id="searchForm">
            <input type="hidden" name="page_size" value="{{ current_page_size }}">
            <input type="hidden" name="sort_by" id="hiddenSortInput" value="{{ current_sort }}">

            <div class="ts-grid is-relaxed">
                <div class="column is-6-wide">
                    <label>çµç®—æ—¥æœŸ (èµ·)</label>
                    <div class="date-picker-wrapper">
                        <input type="text" id="start_date" name="start_date" value="{{ start_date|default:'' }}" placeholder="YYYY-MM-DD">
                        <svg class="calendar-icon" viewBox="0 0 24 24" fill="none" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </div>
                </div>
                <div class="column is-6-wide">
                    <label>çµç®—æ—¥æœŸ (è¿„)</label>
                    <div class="date-picker-wrapper">
                        <input type="text" id="end_date" name="end_date" value="{{ end_date|default:'' }}" placeholder="YYYY-MM-DD">
                        <svg class="calendar-icon" viewBox="0 0 24 24" fill="none" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </div>
                </div>
                
                <div class="column is-12-wide">
                    <div class="ts-grid is-relaxed">
                        <div class="column is-8-wide">
                            <label>æ©Ÿæ§‹åç¨± (æ¸…ç†/è™•ç†)</label>
                            <select name="agency" class="ts-select is-fluid">
                                <option value="">å…¨éƒ¨æ©Ÿæ§‹</option>
                                {% for agency in clear_agencies %}
                                    <option value="{{ agency.id }}" {% if selected_agency == agency.id|stringformat:"s" %}selected{% endif %}>{{ agency.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="column is-4-wide" style="display: flex; align-items: flex-end;">
                            <button type="submit" class="ts-button is-primary is-fluid" style="margin-right: 8px;">
                                <span class="ts-icon is-magnifying-glass-icon"></span> æŸ¥è©¢
                            </button>
                            <button type="button" class="ts-button is-secondary" onclick="window.location.href=window.location.pathname" style="width: 50px;" title="é‡ç½®">
                                <span class="ts-icon is-rotate-left-icon"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="dashboard-panel data-panel">
        <div class="ts-content is-secondary is-fitted" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-bottom: 1px solid var(--tp-border); background-color: var(--tp-bg-panel); border-radius: 6px 6px 0 0;">
            <div style="display: flex; align-items: center; flex-shrink: 1; margin-right: 15px;">
                <div style="font-weight: bold; font-size: 1.05rem; margin-right: 12px; color: var(--tp-text-main); white-space: nowrap;">æŸ¥è©¢çµæœ</div>
                <span style="font-size: 0.9rem; color: var(--tp-text-sub); white-space: nowrap;">(å…± {{ page_obj.paginator.count|default:"0" }} ç­†)</span>
            </div>
            
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;">
                
                <span style="font-size: 0.9rem; color: var(--tp-text-sub); white-space: nowrap;">æ’åºï¼š</span>
                <select class="sort-select ts-select" onchange="submitWithSort(this.value)">
                    <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>æ™‚é–“ (æ–° â†’ èˆŠ)</option>
                    <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>æ™‚é–“ (èˆŠ â†’ æ–°)</option>
                    <option value="weight_desc" {% if current_sort == 'weight_desc' %}selected{% endif %}>é‡é‡ (é‡ â†’ è¼•)</option>
                    <option value="weight_asc" {% if current_sort == 'weight_asc' %}selected{% endif %}>é‡é‡ (è¼• â†’ é‡)</option>
                </select>
                
                <div style="width: 1px; height: 20px; background: var(--tp-border); margin: 0 5px;"></div>
                
                <button class="btn-print-custom" onclick="printSelectedReport()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                        <polyline points="6 9 6 2 18 2 18 9"></polyline>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                        <rect x="6" y="14" width="12" height="8"></rect>
                    </svg>
                    <span id="btnPrintText">åˆ—å°å ±è¡¨</span>
                </button>

                <button type="button" id="btnBatchDelete" class="ts-button is-warning" style="height: 38px !important; border-radius: 4px !important; font-weight: bold; padding: 0 15px !important; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0;" onclick="openBatchDelete()">
                    <span class="ts-icon is-rotate-left-icon" style="margin-right: 6px;"></span> 
                    <span id="btnBatchDeleteText">å–æ¶ˆè¼‰é‹</span>
                </button>
            </div>
        </div>
        
        <div class="ts-content is-fitted" style="overflow-x: auto;">
            <table class="ts-table is-celled is-striped is-fullwidth" id="dataTable">
                <thead>
                    <tr>
                        <th class="collapsing"><label class="ts-checkbox"><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></label></th>
                        <th>çµç®—æ™‚é–“</th>
                        <th>ç¸½é‡é‡ (KG)</th>
                        <th>æ¸…ç†æ©Ÿæ§‹</th>
                        <th>è™•ç†æ©Ÿæ§‹</th>
                        <th>çµç®—äººå“¡</th>
                        <th class="is-center-aligned" style="width: 130px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for batch in page_obj %}
                    <tr>
                        <td class="collapsing">
                            <label class="ts-checkbox">
                                <input type="checkbox" name="batch_ids" value="{{ batch.id }}" class="record-checkbox" data-weight="{{ batch.total_weight }}" onchange="updateUI()">
                            </label>
                        </td>
                        <td>{{ batch.settle_time|date:"Y-m-d H:i" }}</td>
                        <td>
                            <span style="color: #db2828; font-weight: bold;">{{ batch.total_weight }}</span>
                        </td>
                        <td>{{ batch.clear_agency.name }}</td>
                        <td>{{ batch.process_agency.name }}</td>
                        <td>{{ batch.settler.name }}</td>
                        <td class="is-center-aligned">
                            <div style="display: flex; gap: 5px; justify-content: center;">
                                <button class="ts-button is-info is-small is-outlined" style="height: 30px !important;" onclick="openDetailModal('{{ batch.id }}')">
                                    <span class="ts-icon is-eye-icon"></span> æŸ¥çœ‹
                                </button>
                                <button class="ts-button is-warning is-icon is-small is-dense" style="width: 30px !important; height: 30px !important; padding: 0; display: inline-flex; justify-content: center; align-items: center;" onclick="deleteSingleBatch('{{ batch.id }}')" title="å–æ¶ˆè¼‰é‹ç‹€æ…‹">
                                    <span class="ts-icon is-rotate-left-icon"></span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" style="text-align: center !important; padding: 50px 0;">
                            <div class="ts-icon is-box-open-icon" style="font-size: 2.5rem; margin-bottom: 10px; opacity: 0.5; color: var(--tp-text-sub);"></div>
                            <div style="font-size: 1rem; color: var(--tp-text-sub);">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¼‰é‹ç´€éŒ„</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="total-weight-box">
            <span id="weightLabel">æœ¬æŸ¥è©¢çµæœç¸½é‡é‡ï¼š</span>
            <span class="total-weight-value" id="displayTotalWeight" data-original="{{ total_weight_sum }}">{{ total_weight_sum }}</span>
            <span style="font-size: 0.9rem;">KG</span>
        </div>

        <div class="ts-content is-secondary" style="background-color: var(--tp-bg-panel); border-top: 1px solid var(--tp-border); padding: 12px 20px; border-radius: 0 0 6px 6px;">
            <div class="ts-grid is-middle-aligned is-between">
                <div class="column">
                    <div class="ts-wrap is-middle-aligned">
                        <span style="color: var(--tp-text-sub); margin-right: 10px; font-size: 0.95rem;">æ¯é é¡¯ç¤ºï¼š</span>
                        <select class="ts-select is-small" style="width: auto; height: 32px !important;" onchange="changePageSize(this.value)">
                            <option value="10" {% if page_obj.paginator.per_page == 10 %}selected{% endif %}>10</option>
                            <option value="20" {% if page_obj.paginator.per_page == 20 %}selected{% endif %}>20</option>
                            <option value="50" {% if page_obj.paginator.per_page == 50 %}selected{% endif %}>50</option>
                        </select>
                    </div>
                </div>
                <div class="column">
                    <div class="ts-pagination is-small is-secondary">
                        {% with params="start_date="|add:start_date|add:"&end_date="|add:end_date|add:"&agency="|add:selected_agency|add:"&sort_by="|add:current_sort|add:"&page_size="|add:current_page_size %}
                            {% if page_obj.has_previous %}
                                <a class="item" href="?{{ params }}&page={{ page_obj.previous_page_number }}"><span class="ts-icon is-chevron-left-icon"></span></a>
                            {% else %}
                                <span class="item is-disabled"><span class="ts-icon is-chevron-left-icon"></span></span>
                            {% endif %}
                            <span class="item is-text">ç¬¬ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} é </span>
                            {% if page_obj.has_next %}
                                <a class="item" href="?{{ params }}&page={{ page_obj.next_page_number }}"><span class="ts-icon is-chevron-right-icon"></span></a>
                            {% else %}
                                <span class="item is-disabled"><span class="ts-icon is-chevron-right-icon"></span></span>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<dialog id="deleteModal" style="padding:0;border:none;background:transparent;margin:auto;">
    <div class="custom-modal-content">
        <div style="padding:30px 20px 20px;">
            <div class="delete-icon-circle" style="background: #fbbd08 !important; color: #000 !important;">
                <span class="ts-icon is-rotate-left-icon" style="font-size: 30px;"></span>
            </div>
            <div style="font-size:1.3rem;font-weight:bold;margin-bottom:10px;">ç¢ºèªå–æ¶ˆè¼‰é‹</div>
            <p style="font-size:0.95rem; opacity:0.8;">ç¢ºå®šè¦å–æ¶ˆé¸å–çš„è¼‰é‹å–®å—ï¼Ÿ<br>å–®å…§çš„å»¢æ£„ç‰©å°‡æœƒæ¢å¾©æˆã€Œæœªè¼‰é‹ã€ç‹€æ…‹ã€‚</p>
        </div>
        <div style="padding:15px 25px 25px;display:flex;gap:15px;">
            <button class="ts-button" onclick="document.getElementById('deleteModal').close()" style="flex:1; background:var(--del-cancel-bg); color:var(--del-cancel-fg);">è¿”å›</button>
            <button class="ts-button" onclick="confirmDelete()" style="flex:1; background:#fbbd08; color:#000; border: none; font-weight: bold;">ç¢ºå®šå–æ¶ˆ</button>
        </div>
    </div>
</dialog>

<dialog id="detailModal" style="padding:0; border:none; background:transparent; margin:auto;">
    <div class="custom-modal-content">
        <div style="padding: 15px 25px; border-bottom: 1px solid var(--tp-border); font-weight: bold; display: flex; justify-content: space-between;">
            <span id="modalTitle">æ˜ç´°</span>
        </div>
        <div style="padding: 20px; overflow-y: auto;" id="modalBody"></div>
        <div style="padding: 15px 25px; border-top: 1px solid var(--tp-border); text-align: right;">
            <button onclick="document.getElementById('detailModal').close()" class="ts-button is-secondary is-small">é—œé–‰</button>
        </div>
    </div>
</dialog>

{% for batch in page_obj %}
<template id="tmpl-{{ batch.id }}">
    <div style="margin-bottom: 10px; color: var(--tp-text-sub); font-size:0.95rem;">
        å–®è™Ÿï¼š<span style="font-family:monospace;">{{ batch.id }}</span> <br>
        æœ¬æ‰¹æ¬¡åŒ…å« <strong>{{ batch.item_count }}</strong> ç­†å»¢æ£„ç‰©ç´€éŒ„ï¼š
    </div>
    <table class="sub-table">
        <thead>
            <tr><th>å–®ç­† ID</th><th>ç”¢å‡ºéƒ¨é–€</th><th>ç”¢å‡ºå®šé»</th><th>ç”¢å‡ºæ™‚é–“</th><th>é‡é‡ (KG)</th><th>éç£…äººå“¡</th></tr>
        </thead>
        <tbody>
            {% for item in batch.items %}
            <tr>
                <td style="font-family: monospace;">#{{ item.id }}</td>
                <td>{{ item.department.name }}</td><td>{{ item.location.name }}</td>
                <td>{{ item.create_time|date:"Y-m-d H:i" }}</td>
                <td style="text-align: right; font-weight: bold;">{{ item.weight }}</td>
                <td>{{ item.creator.name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="margin-top: 15px; padding-top: 10px; border-top: 2px dashed var(--tp-border); text-align: right; font-weight: bold;">
        ç¸½è¨ˆé‡é‡ï¼š<span style="color: #db2828; font-size: 1.1rem;">{{ batch.total_weight }}</span> KG
    </div>
</template>
{% endfor %}

<script>
    document.addEventListener("DOMContentLoaded", function() {
        flatpickr("#start_date", { locale: "zh_tw", dateFormat: "Y-m-d", allowInput: true });
        flatpickr("#end_date", { locale: "zh_tw", dateFormat: "Y-m-d", allowInput: true });
    });

    window.submitWithSort = function(val) { document.getElementById('hiddenSortInput').value = val; document.getElementById('searchForm').submit(); }
    
    window.changePageSize = function(size) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('page_size', size); urlParams.set('page', 1);
        window.location.search = urlParams.toString();
    }

    window.toggleAll = function(src) { document.querySelectorAll('.record-checkbox').forEach(cb => cb.checked = src.checked); updateUI(); }
    
    window.updateUI = function() {
        const checkboxes = document.querySelectorAll('.record-checkbox:checked');
        const count = checkboxes.length;
        
        // æ›´æ–°æŒ‰éˆ•æ–‡å­—
        document.getElementById('btnBatchDeleteText').innerText = count > 0 ? `å–æ¶ˆè¼‰é‹ (${count})` : "å–æ¶ˆè¼‰é‹";
        document.getElementById('btnPrintText').innerText = count > 0 ? `åˆ—å°å ±è¡¨ (${count})` : "åˆ—å°å ±è¡¨";
        
        // æ›´æ–°ç¸½é‡é‡é¡¯ç¤º
        const weightLabel = document.getElementById('weightLabel');
        const displayTotalWeight = document.getElementById('displayTotalWeight');
        
        if (count > 0) {
            let selectedWeight = 0;
            checkboxes.forEach(cb => {
                selectedWeight += parseFloat(cb.getAttribute('data-weight')) || 0;
            });
            weightLabel.innerText = "å·²é¸å–è³‡æ–™ç¸½é‡é‡ï¼š";
            displayTotalWeight.innerText = selectedWeight.toFixed(2);
        } else {
            weightLabel.innerText = "æœ¬æŸ¥è©¢çµæœç¸½é‡é‡ï¼š";
            displayTotalWeight.innerText = displayTotalWeight.getAttribute('data-original');
        }
    }

    window.printSelectedReport = function() {
        const checkboxes = document.querySelectorAll('.record-checkbox');
        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        
        // éš±è—æœªå‹¾é¸çš„åˆ—
        if (selectedCount > 0) {
            checkboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.closest('tr').classList.add('no-print-row');
                }
            });
        }
        
        window.print();
        
        // æ¢å¾©åŸç‹€
        if (selectedCount > 0) {
            checkboxes.forEach(cb => {
                cb.closest('tr').classList.remove('no-print-row');
            });
        }
    }

    window.pendingDeleteIds = null;
    window.openBatchDelete = function() {
        const ids = Array.from(document.querySelectorAll('.record-checkbox:checked')).map(cb => cb.value);
        if (ids.length === 0) return alert('è«‹è‡³å°‘é¸å–ä¸€ç­†è³‡æ–™');
        window.pendingDeleteIds = ids;
        document.getElementById('deleteModal').showModal();
    }

    window.deleteSingleBatch = function(id) {
        window.pendingDeleteIds = [id];
        document.getElementById('deleteModal').showModal();
    }
    
    window.confirmDelete = function() {
        if (!window.pendingDeleteIds) return;
        fetch("{% url 'dashboard:api_delete_batches' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ ids: window.pendingDeleteIds })
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') window.location.reload();
            else alert('æ“ä½œå¤±æ•—');
        });
    }

    window.openDetailModal = function(id) {
        const tmpl = document.getElementById('tmpl-' + id);
        if (tmpl) {
            document.getElementById('modalBody').innerHTML = tmpl.innerHTML;
            document.getElementById('detailModal').showModal();
        }
    }
</script>
{% endblock %}